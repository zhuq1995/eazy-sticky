# 窗口置顶功能文档

## 功能概述

窗口置顶功能允许用户将便签窗口固定在所有其他窗口之上，确保重要信息始终可见。

## 功能特性

### 1. 置顶按钮
- **位置**: 工具栏左侧（关闭按钮旁边）
- **图标**: 📌 (图钉表情符号)
- **可见性**: 仅在 Electron 环境中显示

### 2. 视觉反馈

#### 未置顶状态
- 图钉图标半透明（opacity: 0.5）
- 鼠标悬停时完全不透明
- 背景透明

#### 置顶状态
- 图钉图标完全不透明（opacity: 1.0）
- 图标旋转 45 度
- 金黄色背景（rgba(255, 215, 0, 0.2)）
- 鼠标悬停时背景更深（rgba(255, 215, 0, 0.3)）

### 3. 交互行为

#### 点击置顶按钮
1. 切换窗口的置顶状态
2. 更新按钮的视觉状态
3. 自动保存新状态到本地存储

#### 状态持久化
- 置顶状态会自动保存
- 应用重启后恢复上次的置顶状态
- 使用防抖机制（500ms）避免频繁保存

## 实现细节

### 需求映射

- **需求 3.1**: 点击置顶按钮时将窗口设置为始终置顶状态
- **需求 3.2**: 窗口处于置顶状态时确保显示在所有非置顶窗口之上
- **需求 3.3**: 再次点击置顶按钮时取消窗口的置顶状态
- **需求 3.4**: 窗口置顶状态改变时更新置顶按钮的视觉状态
- **需求 3.5**: 窗口置顶状态改变时保存新的置顶状态到存储

### 技术实现

#### 组件集成
```vue
<!-- StickyNote.vue -->
<button 
  v-if="isElectron" 
  class="pin-btn" 
  :class="{ 'pinned': windowOps.windowState.value.isAlwaysOnTop }"
  @click="handleTogglePin"
>
  📌
</button>
```

#### 状态管理
- 使用 `useWindow` composable 管理置顶状态
- 响应式状态自动更新 UI
- 自动保存机制处理持久化

#### Electron API
- `window.electronAPI.window.setAlwaysOnTop(boolean)`
- `window.electronAPI.window.isAlwaysOnTop()`

## 手动测试指南

### 测试环境
- **Electron 环境**: 完整功能
- **浏览器环境**: 置顶按钮不显示

### 测试步骤

#### 1. 基础功能测试
1. 启动应用（Electron 模式）
2. 验证工具栏中显示置顶按钮（📌）
3. 点击置顶按钮
4. 验证按钮视觉状态改变（旋转 45 度，金黄色背景）
5. 打开其他应用窗口
6. 验证便签窗口始终显示在最上层

#### 2. 状态切换测试
1. 在置顶状态下，再次点击置顶按钮
2. 验证按钮恢复到未置顶状态
3. 验证窗口不再置顶（可被其他窗口覆盖）
4. 多次切换置顶状态，验证每次都正常工作

#### 3. 持久化测试
1. 将窗口设置为置顶状态
2. 关闭应用
3. 重新启动应用
4. 验证窗口恢复到置顶状态
5. 验证置顶按钮显示正确的视觉状态

#### 4. 浏览器环境测试
1. 在浏览器中打开应用（npm run dev）
2. 验证置顶按钮不显示
3. 验证其他功能正常工作

### 预期结果

✅ 置顶按钮在 Electron 环境中可见
✅ 点击按钮切换置顶状态
✅ 置顶状态有明显的视觉反馈
✅ 置顶窗口始终显示在其他窗口之上
✅ 置顶状态在应用重启后保持
✅ 浏览器环境中不显示置顶按钮

## 故障排除

### 问题：置顶按钮不显示
- **原因**: 不在 Electron 环境中
- **解决**: 使用 `npm run dev:electron` 启动 Electron 版本

### 问题：点击按钮无反应
- **原因**: Electron API 未正确初始化
- **解决**: 检查 preload.ts 和 main.ts 中的 IPC 处理器

### 问题：置顶状态不保存
- **原因**: localStorage 访问失败
- **解决**: 检查浏览器/Electron 的存储权限

### 问题：窗口不置顶
- **原因**: Electron API 调用失败
- **解决**: 检查控制台错误日志，验证 IPC 通信

## 相关文件

- `src/components/StickyNote.vue` - 置顶 UI 实现
- `src/composables/useWindow.ts` - 窗口状态管理
- `electron/main.ts` - Electron 窗口管理
- `electron/preload.ts` - IPC API 暴露
- `src/components/__tests__/StickyNote.electron.test.ts` - 单元测试

## 未来改进

1. **快捷键支持**: 添加键盘快捷键切换置顶状态
2. **批量操作**: 支持一次性置顶/取消置顶所有窗口
3. **置顶级别**: 支持不同的置顶优先级
4. **自动置顶**: 根据内容或时间自动置顶重要便签
5. **置顶提示**: 首次使用时显示功能提示
