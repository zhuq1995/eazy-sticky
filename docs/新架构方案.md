# 便利贴应用新架构方案

## 问题分析

### 当前问题
- 无边框窗口拖拽存在抖动问题
- 自定义拖拽逻辑复杂且性能不佳
- 按钮点击与拖拽事件冲突

### 根本原因
无边框窗口（`frame: false`）需要自己实现拖拽，这导致：
1. 需要在渲染进程捕获鼠标事件
2. 通过 IPC 通知主进程移动窗口
3. 存在延迟和同步问题
4. 性能开销大

## 新架构方案

### 核心思路
**使用系统原生窗口边框，利用操作系统的原生拖拽**

### 窗口类型

#### 1. 主窗口（管理窗口）
- **用途**：管理所有便利贴、应用设置
- **特点**：
  - 有边框（`frame: true`）
  - 正常的窗口控制按钮
  - 可以最小化到托盘
  - 显示所有便利贴列表
  - 提供创建、删除、编辑便利贴功能

#### 2. 便利贴子窗口
- **用途**：显示单个便利贴内容
- **特点**：
  - **有边框**（`frame: true`）- 关键改变！
  - 标题栏显示便利贴标题
  - 系统原生的关闭、最小化、置顶按钮
  - 可以调整大小
  - 自动保存位置和内容

## 详细设计

### 窗口配置

#### 主窗口配置
```typescript
const MAIN_WINDOW_CONFIG = {
    width: 800,
    height: 600,
    minWidth: 600,
    minHeight: 400,
    frame: true,              // 有边框
    transparent: false,       // 不透明
    backgroundColor: '#ffffff',
    resizable: true,
    minimizable: true,
    maximizable: true,
    closable: true,
    alwaysOnTop: false,
    title: '便利贴管理',
    webPreferences: {
        preload: join(__dirname, '../preload/preload.js'),
        nodeIntegration: false,
        contextIsolation: true,
        sandbox: true,
        webSecurity: true
    }
}
```

#### 便利贴窗口配置
```typescript
const NOTE_WINDOW_CONFIG = {
    width: 300,
    height: 300,
    minWidth: 200,
    minHeight: 200,
    frame: true,              // ✅ 有边框 - 关键！
    transparent: false,       // 不透明
    backgroundColor: '#fef9e7',
    resizable: true,
    minimizable: true,
    maximizable: false,       // 便利贴不需要最大化
    closable: true,
    alwaysOnTop: false,       // 可以通过菜单切换
    title: '便利贴',          // 显示在标题栏
    webPreferences: {
        preload: join(__dirname, '../preload/preload.js'),
        nodeIntegration: false,
        contextIsolation: true,
        sandbox: true,
        webSecurity: true
    }
}
```

### 功能分配

#### 主窗口功能
1. **便利贴列表**
   - 显示所有便利贴
   - 显示便利贴预览
   - 点击打开对应的便利贴窗口

2. **便利贴管理**
   - 创建新便利贴
   - 删除便利贴
   - 搜索便利贴

3. **应用设置**
   - 主题设置
   - 自启动设置
   - 快捷键设置

4. **托盘集成**
   - 最小化到托盘
   - 托盘菜单快速创建便利贴

#### 便利贴窗口功能
1. **内容编辑**
   - 富文本编辑
   - 自动保存

2. **窗口控制**（通过系统标题栏）
   - 拖拽移动（系统原生）
   - 调整大小（系统原生）
   - 关闭（系统原生按钮）
   - 最小化（系统原生按钮）

3. **自定义菜单**
   - 右键菜单或标题栏菜单
   - 置顶/取消置顶
   - 更改颜色
   - 删除便利贴

## 优势

### 1. 性能优势
- ✅ 使用系统原生拖拽，无延迟
- ✅ 无需自定义拖拽逻辑
- ✅ 无 IPC 通信开销
- ✅ CPU 使用率低

### 2. 用户体验优势
- ✅ 拖拽流畅，无抖动
- ✅ 符合系统原生体验
- ✅ 用户熟悉的操作方式
- ✅ 无学习成本

### 3. 开发优势
- ✅ 代码简单，易维护
- ✅ 无需处理复杂的拖拽逻辑
- ✅ 无需处理按钮点击冲突
- ✅ 利用 Electron 内置功能

### 4. 稳定性优势
- ✅ 系统原生功能，稳定可靠
- ✅ 跨平台一致性好
- ✅ 无边缘情况

## 实现步骤

### 第一步：修改窗口配置
1. 修改 `DEFAULT_WINDOW_CONFIG`
   - `frame: true`
   - `transparent: false`

### 第二步：创建主窗口
1. 创建主窗口组件 `MainWindow.vue`
2. 实现便利贴列表
3. 实现创建/删除功能

### 第三步：修改便利贴窗口
1. 移除自定义拖拽逻辑
2. 移除工具栏（关闭、固定按钮）
3. 简化为纯内容编辑区

### 第四步：实现窗口通信
1. 主窗口 ↔ 便利贴窗口
2. 便利贴创建/删除/更新通知

### 第五步：实现菜单
1. 标题栏右键菜单
2. 置顶/取消置顶
3. 更改颜色
4. 删除便利贴

## 用户界面

### 主窗口界面
```
┌─────────────────────────────────────┐
│ 便利贴管理                    - □ ×  │
├─────────────────────────────────────┤
│ [+ 新建便利贴]  [搜索...]  [设置]   │
├─────────────────────────────────────┤
│                                     │
│  ┌──────────┐  ┌──────────┐       │
│  │便利贴 1  │  │便利贴 2  │       │
│  │今天要做  │  │明天计划  │       │
│  │的事情... │  │...       │       │
│  └──────────┘  └──────────┘       │
│                                     │
│  ┌──────────┐  ┌──────────┐       │
│  │便利贴 3  │  │便利贴 4  │       │
│  │...       │  │...       │       │
│  └──────────┘  └──────────┘       │
│                                     │
└─────────────────────────────────────┘
```

### 便利贴窗口界面
```
┌─────────────────────────────────────┐
│ 便利贴 - 今天要做的事情      - □ ×  │ ← 系统标题栏
├─────────────────────────────────────┤
│                                     │
│  今天要做的事情：                   │
│  1. 完成项目报告                    │
│  2. 回复邮件                        │
│  3. 准备明天的会议                  │
│                                     │
│                                     │
│                                     │
│                                     │
└─────────────────────────────────────┘
```

## 迁移计划

### 保留的功能
- ✅ 内容编辑
- ✅ 自动保存
- ✅ 位置记忆
- ✅ 尺寸调整
- ✅ 置顶功能

### 移除的功能
- ❌ 自定义拖拽逻辑（`useDraggable`）
- ❌ 自定义工具栏
- ❌ 透明窗口
- ❌ 无边框窗口

### 新增的功能
- ✅ 主窗口管理界面
- ✅ 便利贴列表
- ✅ 便利贴搜索
- ✅ 右键菜单

## 技术栈

### 保持不变
- Electron
- Vue 3
- TypeScript
- Vite

### 简化的部分
- 不需要 `useDraggable`
- 不需要 `useResizable`（使用系统原生）
- 简化的 `useWindow`

## 下一步

1. **确认方案**：确认这个方案是否符合需求
2. **创建主窗口**：实现主窗口界面
3. **修改便利贴窗口**：改为有边框窗口
4. **测试**：验证拖拽流畅性
5. **完善功能**：添加菜单、设置等

## 预期效果

- ✅ 拖拽完全流畅，无任何抖动
- ✅ 性能优秀
- ✅ 用户体验好
- ✅ 代码简单易维护
- ✅ 跨平台一致性好
