# 实现计划 - 高级窗口功能

## 任务列表

- [x] 1. 扩展类型定义





  - 在 `src/types/index.ts` 中添加窗口功能相关类型
  - 定义 WindowState、WindowInfo、DragState 等接口
  - 定义 UseDraggableOptions、UseWindowOptions 等配置类型
  - 定义多窗口管理相关类型
  - 添加 ElectronAPI 的窗口操作扩展
  - _需求: 1.1, 3.1, 4.1, 6.1_

- [x] 2. 实现拖拽 Composable





  - 创建 `src/composables/useDraggable.ts` 文件
  - 实现基于鼠标事件的拖拽逻辑
  - 实现边界限制功能（左、上、右、下边界）
  - 实现最小可见区域保证（50像素）
  - 实现拖拽状态管理（isDragging）
  - 实现拖拽视觉反馈（CSS类）
  - 实现可编辑区域检测，防止误触发
  - 使用 requestAnimationFrame 优化性能
  - 实现拖拽结束后的防抖保存
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 2.5, 10.1, 10.2, 10.3, 12.1, 12.2, 12.3, 12.4, 12.5_

- [ ]* 2.1 编写拖拽功能的属性测试
  - **属性 1-5: 拖拽操作基础属性**
  - **验证需求: 1.1, 1.2, 1.3, 1.4, 1.5**

- [ ]* 2.2 编写边界限制的属性测试
  - **属性 6-10: 边界限制属性**
  - **验证需求: 2.1, 2.2, 2.3, 2.4, 2.5**

- [ ]* 2.3 编写拖拽性能的属性测试
  - **属性 42-46: 拖拽性能属性**
  - **验证需求: 10.1, 10.2, 10.3, 10.4, 10.5**

- [ ]* 2.4 编写拖拽动画的属性测试
  - **属性 51-55: 拖拽动画属性**
  - **验证需求: 12.1, 12.2, 12.3, 12.4, 12.5**

- [x] 3. 实现窗口操作 Composable





  - 创建 `src/composables/useWindow.ts` 文件
  - 实现窗口状态管理（position, size, isAlwaysOnTop）
  - 实现响应式窗口状态
  - 实现窗口位置设置和获取
  - 实现窗口尺寸设置和获取（带最小/最大限制）
  - 实现窗口置顶状态切换
  - 实现边界检查功能
  - 实现窗口状态保存和恢复
  - 实现防抖自动保存
  - 添加组件卸载时的清理逻辑
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 6.1, 6.2, 6.3, 6.4, 6.5, 7.1, 7.2, 7.3, 7.4, 7.5, 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ]* 3.1 编写窗口置顶的属性测试
  - **属性 11-15: 窗口置顶属性**
  - **验证需求: 3.1, 3.2, 3.3, 3.4, 3.5**

- [ ]* 3.2 编写窗口状态的属性测试
  - **属性 24-28: 窗口状态响应式属性**
  - **验证需求: 6.1, 6.2, 6.3, 6.4, 6.5**

- [ ]* 3.3 编写窗口尺寸的属性测试
  - **属性 32-36: 窗口尺寸属性**
  - **验证需求: 8.1, 8.2, 8.3, 8.4, 8.5**

- [x] 4. 实现多窗口管理 Composable





  - 创建 `src/composables/useMultiWindow.ts` 文件
  - 实现窗口列表管理
  - 实现创建窗口功能（带位置偏移）
  - 实现关闭窗口功能
  - 实现聚焦窗口功能
  - 实现窗口信息查询和更新
  - 实现窗口数量限制（最大20个）
  - 实现窗口间广播通信
  - 实现窗口间事件监听
  - 计算新窗口位置避免重叠
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 5.3, 5.4, 5.5, 9.1, 9.2, 9.3, 9.4, 9.5_

- [ ]* 4.1 编写窗口创建的属性测试
  - **属性 16-19: 窗口创建属性**
  - **验证需求: 4.1, 4.2, 4.3, 4.4**

- [ ]* 4.2 编写窗口关闭的属性测试
  - **属性 20-23: 窗口关闭属性**
  - **验证需求: 5.1, 5.2, 5.3, 5.4**

- [ ]* 4.3 编写窗口间通信的属性测试
  - **属性 37-41: 窗口间通信属性**
  - **验证需求: 9.1, 9.2, 9.3, 9.4, 9.5**

- [x] 5. 扩展主进程窗口管理器





  - 更新 `electron/main.ts` 扩展 WindowManager 类
  - 实现 createWindow 方法支持自定义位置和尺寸
  - 实现 setAlwaysOnTop 方法
  - 实现 isAlwaysOnTop 查询方法
  - 实现 getAllWindowsInfo 方法
  - 实现 broadcastToAll 广播方法
  - 实现 sendToWindow 单播方法
  - 实现 calculateNewWindowPosition 计算新窗口位置
  - 实现 isPositionInScreen 屏幕范围检查
  - 实现 adjustPositionToScreen 位置调整
  - 维护窗口映射表（windowId -> BrowserWindow）
  - _需求: 4.1, 4.2, 4.3, 7.4, 9.1_

- [x] 6. 注册多窗口 IPC 处理器





  - 在 `electron/main.ts` 中注册多窗口相关的 IPC 处理器
  - 实现 multiWindow:create 处理器
  - 实现 multiWindow:close 处理器
  - 实现 multiWindow:focus 处理器
  - 实现 multiWindow:broadcast 处理器
  - 实现 window:setAlwaysOnTop 处理器
  - 实现 window:isAlwaysOnTop 处理器
  - 添加错误处理和日志记录
  - _需求: 3.1, 3.2, 4.1, 5.1, 9.1_

- [x] 7. 更新预加载脚本





  - 更新 `electron/preload.ts` 添加多窗口 API
  - 暴露 multiWindow.create API
  - 暴露 multiWindow.close API
  - 暴露 multiWindow.focus API
  - 暴露 multiWindow.broadcast API
  - 暴露 window.setAlwaysOnTop API
  - 暴露 window.isAlwaysOnTop API
  - 更新 ElectronAPI 类型定义
  - _需求: 3.1, 4.1, 5.1, 9.1_
-

- [x] 8. 集成拖拽到 StickyNote 组件




  - 更新 `src/components/StickyNote.vue` 集成拖拽功能
  - 使用 useDraggable composable
  - 设置拖拽句柄（标题栏或整个窗口）
  - 排除可编辑区域的拖拽触发
  - 添加拖拽状态的视觉反馈样式
  - 实现拖拽结束后保存位置
  - 测试拖拽功能在浏览器和 Electron 环境
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 7.1_

- [x] 9. 实现窗口置顶 UI





  - 在 StickyNote 组件中添加置顶按钮
  - 使用 useWindow composable 管理置顶状态
  - 实现置顶按钮点击事件处理
  - 添加置顶状态的视觉指示（图标变化）
  - 实现置顶状态的持久化
  - 测试置顶功能
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_



- [x] 10. 实现窗口尺寸调整



  - 在 StickyNote 组件中添加尺寸调整功能
  - 实现拖拽边缘/角落调整尺寸
  - 实现最小尺寸限制（200x200）
  - 实现最大尺寸限制（800x800）
  - 实现尺寸变更时的内容区域自适应
  - 实现尺寸变更的持久化
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 11. 实现多窗口创建功能




  - 在 App.vue 中集成 useMultiWindow
  - 实现创建新便签窗口的按钮/菜单
  - 实现窗口列表显示
  - 实现窗口数量限制提示
  - 测试多窗口创建和管理
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_
-

- [x] 12. 实现快捷键支持



  - 在主进程中注册全局快捷键（Ctrl+N / Cmd+N）
  - 实现快捷键触发创建新窗口
  - 实现新窗口位置计算（鼠标位置或聚焦窗口附近）
  - 实现新窗口自动聚焦
  - 添加快捷键冲突处理和警告
  - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_

- [x] 13. 实现窗口间数据同步





  - 在 notes store 中实现数据变更广播
  - 实现窗口订阅数据变更事件
  - 实现接收通知后的数据刷新
  - 实现窗口创建时的事件订阅
  - 实现窗口关闭时的事件取消订阅
  - 添加同步失败的错误处理
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_


- [x] 14. 扩展 Store 支持窗口状态




  - 更新 `src/stores/notes.ts` 添加窗口状态管理
  - 实现 saveWindowState 方法
  - 实现 loadWindowState 方法
  - 实现多窗口状态的独立保存
  - 实现窗口状态的版本管理
  - _需求: 7.1, 7.2, 7.3, 7.5_

- [x] 15. 添加拖拽和窗口样式





  - 在 `src/styles/main.css` 中添加拖拽相关样式
  - 添加 .dragging CSS 类样式
  - 添加置顶状态的视觉样式
  - 添加窗口尺寸调整的光标样式
  - 优化拖拽时的过渡动画
  - 确保使用 CSS transform 而非 top/left
  - _需求: 1.4, 3.4, 12.1, 12.2, 12.3, 12.4, 12.5_
- [x] 16. 创建属性测试数据生成器




- [ ] 16. 创建属性测试数据生成器

  - 安装 fast-check（如果尚未安装）
  - 创建 `tests/window-generators.ts` 文件
  - 实现窗口位置生成器
  - 实现窗口尺寸生成器
  - 实现拖拽状态生成器
  - 实现窗口列表生成器
  - _需求: 所有需求（测试支持）_
- [x] 17. 性能优化和测试





- [ ] 17. 性能优化和测试

  - 测试拖拽帧率（目标60fps）
  - 测试多窗口同时拖拽性能
  - 优化内存使用
  - 测试窗口创建时间
  - 测试窗口间同步延迟
  - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 18. 最终检查点


  - 确保所有测试通过，如有问题请询问用户
  - 验证拖拽功能流畅运行
  - 验证窗口置顶功能正常
  - 验证多窗口创建和管理正常
  - 验证窗口状态持久化正常
  - 验证窗口间数据同步正常
